var sha512 = require('hash.js').sha512;
var BN = require('bn.js');

var emoji = document.getElementById('emoji');
var email = document.getElementById('email');
var form = document.getElementById('subscribe');
var submit = document.getElementById('submit');

var smile = [
  "ğŸ˜€",    "ğŸ˜ƒ",      "ğŸ˜„",    "ğŸ˜†", "ğŸ˜…",    "ğŸ˜‚",    "â˜ºï¸", "ğŸ˜Š",
  "ğŸ˜‡",    "ğŸ™‚",   "ğŸ™ƒ", "ğŸ˜‰", "ğŸ˜Œ",    "ğŸ˜",    "ğŸ˜˜",      "ğŸ˜—",
  "ğŸ˜™",    "ğŸ˜š",      "ğŸ˜‹",    "ğŸ˜œ", "ğŸ˜",    "ğŸ˜›",    "ğŸ¤‘",   "ğŸ¤—",
  "ğŸ¤“", "ğŸ˜",      "ğŸ˜",    "ğŸ˜’", "ğŸ˜",    "ğŸ˜”",    "ğŸ˜Ÿ",      "ğŸ˜¬",
  "ğŸ™", "â˜¹ï¸", "ğŸ˜£",    "ğŸ˜–", "ğŸ˜«",    "ğŸ˜©",    "ğŸ˜¤",      "ğŸ˜•",
  "ğŸ˜¡",    "ğŸ˜¶",      "ğŸ˜",    "ğŸ˜‘", "ğŸ˜¯",    "ğŸ˜¦",    "ğŸ˜§",      "ğŸ˜®",
  "ğŸ˜²",    "ğŸ˜µ",      "ğŸ˜³",    "ğŸ˜¨", "ğŸ˜°",    "ğŸ˜¢",    "ğŸ˜¥",      "ğŸ˜",
  "ğŸ˜­",    "ğŸ˜“",      "ğŸ˜ª",    "ğŸ˜´", "ğŸ™„", "ğŸ¤”", "ğŸ˜ ",      "ğŸ¤",
  "ğŸ˜·",    "ğŸ¤’",   "ğŸ¤•", "ğŸ˜ˆ", "ğŸ‘¿",    "ğŸ‘»",    "ğŸ’€",      "â˜ ï¸",
  "ğŸ‘½",    "ğŸ‘¾",      "ğŸ¤–", "ğŸƒ", "ğŸ˜º",    "ğŸ˜¸",    "ğŸ˜¹",      "ğŸ˜»",
  "ğŸ˜¼",    "ğŸ˜½",      "ğŸ˜¿",    "ğŸ˜¾"];
var gesture = [
  "ğŸ‘", "ğŸ‘Œ",      "ğŸ‘", "ğŸ™",    "ğŸ‘", "ğŸ‘", "ğŸ‘Š",
  "âœŠ", "âœŒï¸", "ğŸ™Œ", "ğŸ¤˜", "ğŸ‘ˆ", "ğŸ‘‰", "ğŸ‘†",
  "ğŸ‘‡", "â˜ï¸", "âœ‹", "ğŸ––", "ğŸ‘‹", "ğŸ’ª"];
var animal = [
  "ğŸ¶",    "ğŸ±",    "ğŸ­",    "ğŸ¹", "ğŸ°",    "ğŸ»",    "ğŸ¼",   "ğŸ¨", "ğŸ¯", "ğŸ¦",
  "ğŸ¦ƒ", "ğŸ·",    "ğŸ®",    "ğŸµ", "ğŸ’",    "ğŸ”",    "ğŸ§",   "ğŸ¦", "ğŸ¤", "ğŸ£",
  "ğŸ¥",    "ğŸº",    "ğŸ—",    "ğŸ´", "ğŸ¦„", "ğŸ",    "ğŸ›",   "ğŸŒ", "ğŸš", "ğŸ",
  "ğŸœ",    "ğŸ•·", "ğŸ¢",    "ğŸ", "ğŸ¦‚", "ğŸ¦€", "ğŸ™",   "ğŸ ", "ğŸŸ", "ğŸ¡",
  "ğŸ¬",    "ğŸ³",    "ğŸ‹",    "ğŸŠ", "ğŸ†",    "ğŸ…",    "ğŸƒ",   "ğŸ‚", "ğŸ„", "ğŸª",
  "ğŸ«",    "ğŸ˜",    "ğŸ",    "ğŸ–", "ğŸ",    "ğŸ",    "ğŸ‘",   "ğŸ•", "ğŸ©", "ğŸˆ",
  "ğŸ“",    "ğŸ½",    "ğŸ•Š", "ğŸ‡", "ğŸ",    "ğŸ€",    "ğŸ¿"];
var food = [
  "ğŸ", "ğŸ", "ğŸ",      "ğŸŠ", "ğŸ‹", "ğŸŒ",    "ğŸ‰", "ğŸ‡", "ğŸ“",    "ğŸˆ",    "ğŸ’",
  "ğŸ‘", "ğŸ", "ğŸ…",      "ğŸ†", "ğŸŒ½", "ğŸŒ¶", "ğŸ ", "ğŸŒ°", "ğŸ¯",    "ğŸ",    "ğŸ§€",
  "ğŸ³", "ğŸ¤", "ğŸ—",      "ğŸ–", "ğŸ•", "ğŸŒ­", "ğŸ”", "ğŸŸ", "ğŸŒ®", "ğŸŒ¯", "ğŸ",
  "ğŸœ", "ğŸ²", "ğŸ¥",      "ğŸ£", "ğŸ±", "ğŸ›",    "ğŸš", "ğŸ™", "ğŸ˜",    "ğŸ¢",    "ğŸ¡",
  "ğŸ§", "ğŸ¨", "ğŸ¦",      "ğŸº", "ğŸ‚", "ğŸ®",    "ğŸ­", "ğŸ¬", "ğŸ«",    "ğŸ¿", "ğŸ©",
  "ğŸª", "ğŸ°", "â˜•ï¸", "ğŸµ", "ğŸ¶", "ğŸ¼",    "ğŸ»", "ğŸ·", "ğŸ¸",    "ğŸ¹",    "ğŸ¾"];
var object = [
  "âŒšï¸", "ğŸ“±",      "ğŸ’»",       "âŒ¨ï¸", "ğŸ–¥",   "ğŸ–¨", "ğŸ–±",
  "ğŸ–²",   "ğŸ•¹",   "ğŸ—œ",    "ğŸ’¾",      "ğŸ’¿",      "ğŸ“¼",    "ğŸ“·",
  "ğŸ—‘",   "ğŸ",   "ğŸ“",       "â˜ï¸", "ğŸ“Ÿ",      "ğŸ“ ",    "ğŸ“º",
  "ğŸ“»",      "ğŸ™",   "â±",       "âŒ›ï¸", "ğŸ“¡",      "ğŸ”‹",    "ğŸ”Œ",
  "ğŸ’¡",      "ğŸ”¦",      "ğŸ•¯",    "ğŸ’·",      "ğŸ›¢",   "ğŸ’µ",    "ğŸ’´",
  "ğŸ¥",      "ğŸ’¶",      "ğŸ’³",       "ğŸ’",      "âš–ï¸", "ğŸ”§",    "ğŸ”¨",
  "ğŸ”©",      "âš™ï¸", "ğŸ”«",       "ğŸ’£",      "ğŸ”ª",      "ğŸ—¡", "ğŸš¬",
  "ğŸ”®",      "ğŸ“¿",   "ğŸ’ˆ",       "âš—ï¸", "ğŸ”­",      "ğŸ”¬",    "ğŸ•³",
  "ğŸ’Š",      "ğŸ’‰",      "ğŸŒ¡",    "ğŸš½",      "ğŸš°",      "ğŸ›",    "ğŸ›",
  "ğŸ—",   "ğŸšª",      "ğŸ›‹",    "ğŸ›",   "ğŸ–¼",   "ğŸ›", "ğŸ",
  "ğŸˆ",      "ğŸ€",      "ğŸ‰",       "âœ‰ï¸", "ğŸ“¦",      "ğŸ·", "ğŸ“«",
  "ğŸ“¯",      "ğŸ“œ",      "ğŸ“†",       "ğŸ“…",      "ğŸ“‡",      "ğŸ—ƒ", "ğŸ—„",
  "ğŸ“‹",      "ğŸ“‚",      "ğŸ—",    "ğŸ““",      "ğŸ“–",      "ğŸ”—",    "ğŸ“",
  "ğŸ“",      "ğŸ“Œ",      "ğŸ³ï¸", "ğŸŒˆ",      "âœ‚ï¸", "ğŸ–Œ", "âœï¸",
  "ğŸ”",      "ğŸ”’",      "ğŸ´"];
var alphabet = [ smile, gesture, animal, food, object ];

function onChange() {
  if (email.value === '') {
    emoji.textContent = 'ğŸ˜¬';
    return;
  }

  var text = 'derivepass/' + email.value;
  var digest = sha512().update(text).digest();

  var fingerprint = new BN(digest.slice(0, 8), 'le');

  var out = '';
  for (var i = 0; i < alphabet.length; i++) {
    var idx = fingerprint.modn(alphabet[i].length);
    fingerprint.idivn(alphabet[i].length);

    out += alphabet[i][idx];
  }

  emoji.textContent = out;
}

email.onkeyup = onChange;
email.onkeypress = onChange;

form.onsubmit = function() {
  email.disabled = true;
  submit.disabled = true;

  var req = new XMLHttpRequest();;

  req.onreadystatechange = function() {
    if (req.readyState !== XMLHttpRequest.DONE)
      return;

    if (req.status !== 200)
      emoji.textContent = 'Unknown error, please retry later';
    else
      emoji.textContent = 'Subscribed, thank you!';
  };

  req.open('POST', '/api/subscribe', true);
  req.setRequestHeader('Content-Type', 'application/json');
  req.send(JSON.stringify({ email: email.value }));
};
